#!/bin/bash
# Copyright Offene Werkstatt W√§denswil
# SPDX-License-Identifier: MIT
#
# Pigweed workflow launcher wrapper script.
#
# This script runs bazel in an isolated environment that doesn't interfere
# with the IDE's compile_commands. Use this for:
# - Flashing firmware (./pw flash)
# - Running workflow builds (./pw build host, ./pw build p2)
# - Any command that shouldn't update compile_commands

# Don't generate compile commands from this action.
# BAZELISK_SKIP_WRAPPER=1 tells bazelisk to skip the tools/bazel wrapper.
export BAZELISK_SKIP_WRAPPER=1

declare -r _PW_SCRIPT_DIR=$(realpath $(dirname $0))
declare -r _PW_WORKFLOWS_OUT_DIR=${_PW_SCRIPT_DIR}/out/workflows_launcher

# Handle special commands that need 'bazel run' instead of workflows
case "$1" in
  flash)
    # Flash requires 'bazel run' to actually execute the flash script
    echo "üîå Flashing firmware..."
    exec bazelisk run //maco_firmware/apps/dev:flash
    ;;
  run)
    # Allow running arbitrary targets: ./pw run //target
    shift
    exec bazelisk run "$@"
    ;;
  test)
    # Run host unit tests without affecting IDE state
    shift
    TARGETS="${@:-//maco_firmware/...}"
    echo "üß™ Running tests..."
    exec bazelisk \
      --output_base=${_PW_WORKFLOWS_OUT_DIR} \
      test \
      --symlink_prefix=${_PW_WORKFLOWS_OUT_DIR}/bazel- \
      $TARGETS
    ;;
esac

# For all other commands, use the workflows launcher
if [ -t 1 ]; then
  printf " ‚è±  Initializing pw tool...\r"
fi

declare -r _PW_WORKFLOWS_BIN_PATH=${_PW_WORKFLOWS_OUT_DIR}/bazel-bin/pw.exe

# If the `pw` tool hasn't been built yet, don't silence output since it might
# take a long time.
if [ -f "$_PW_WORKFLOWS_BIN_PATH" ]; then
  declare -r _PW_WORKFLOWS_QUIET=--quiet
else
  declare -r _PW_WORKFLOWS_QUIET
fi

bazelisk \
  ${_PW_WORKFLOWS_QUIET} \
  --output_base=${_PW_WORKFLOWS_OUT_DIR} \
  run \
  --symlink_prefix=${_PW_WORKFLOWS_OUT_DIR}/bazel- \
  --show_result=0 \
  //:pw -- "$@"
