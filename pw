#!/bin/bash
# Copyright Offene Werkstatt W√§denswil
# SPDX-License-Identifier: MIT
#
# Pigweed workflow launcher wrapper script.
#
# This script runs bazel in an isolated environment that doesn't interfere
# with the IDE's compile_commands. Use this for:
# - Flashing firmware (./pw flash)
# - Running workflow builds (./pw build host, ./pw build p2)
# - Any command that shouldn't update compile_commands

# Don't generate compile commands from this action.
# BAZELISK_SKIP_WRAPPER=1 tells bazelisk to skip the tools/bazel wrapper.
export BAZELISK_SKIP_WRAPPER=1

declare -r _PW_SCRIPT_DIR=$(realpath $(dirname $0))
declare -r _PW_WORKFLOWS_OUT_DIR=${_PW_SCRIPT_DIR}/out/workflows_launcher

# Handle special commands that need 'bazel run' instead of workflows
case "$1" in
  flash)
    # Flash requires 'bazel run' to actually execute the flash script
    echo "üîå Flashing firmware..."
    exec bazelisk run //maco_firmware/apps/dev:flash
    ;;
  run)
    # Allow running arbitrary targets: ./pw run //target
    shift
    exec bazelisk run "$@"
    ;;
  test)
    # Run host unit tests without affecting IDE state
    shift
    TARGETS="${@:-//maco_firmware/...}"
    echo "üß™ Running tests..."
    exec bazelisk \
      --output_base=${_PW_WORKFLOWS_OUT_DIR} \
      test \
      --symlink_prefix=${_PW_WORKFLOWS_OUT_DIR}/bazel- \
      $TARGETS
    ;;
  console-sim)
    # Launch simulator and connect console
    # Token database is a Bazel data dependency - always in sync
    echo "üñ•Ô∏è  Launching simulator with console..."
    MACO_PROJECT_ROOT="$_PW_SCRIPT_DIR" exec bazelisk run //maco_firmware/apps/dev:console_sim
    ;;
  console)
    # Connect to Particle device via serial
    # Token database is a Bazel data dependency - always in sync
    # Usage: ./pw console [--device-serial=XXXX]

    # Parse --device-serial argument
    DEVICE_SERIAL=""
    for arg in "$@"; do
      case "$arg" in
        --device-serial=*)
          DEVICE_SERIAL="${arg#*=}"
          ;;
      esac
    done

    find_particle_device() {
      local serial_filter="$1"
      local timeout=30
      local elapsed=0

      while (( elapsed < timeout )); do
        local devices=(/dev/particle_*)

        if [[ -e "${devices[0]}" ]]; then
          if [[ -n "$serial_filter" ]]; then
            # Filter by serial (match suffix)
            for dev in "${devices[@]}"; do
              if [[ "$dev" == *"$serial_filter" ]]; then
                echo "$dev"
                return 0
              fi
            done
          elif (( ${#devices[@]} == 1 )); then
            echo "${devices[0]}"
            return 0
          else
            # Multiple devices, prompt user
            echo "üîå Multiple Particle devices found:" >&2
            local i=1
            for dev in "${devices[@]}"; do
              echo "   $i) $dev" >&2
              ((i++))
            done
            echo -n "Select device [1-${#devices[@]}]: " >&2
            read -r selection
            if [[ "$selection" =~ ^[0-9]+$ ]] && (( selection >= 1 && selection <= ${#devices[@]} )); then
              echo "${devices[$((selection-1))]}"
              return 0
            fi
            echo "‚ùå Invalid selection" >&2
            return 1
          fi
        fi

        if (( elapsed == 0 )); then
          if [[ -n "$serial_filter" ]]; then
            echo "‚è≥ Waiting for device *$serial_filter..." >&2
          else
            echo "‚è≥ Waiting for Particle device..." >&2
          fi
        fi
        sleep 1
        ((elapsed++))
      done

      echo "‚ùå No matching Particle device found" >&2
      return 1
    }

    DEVICE=$(find_particle_device "$DEVICE_SERIAL") || exit 1

    # Extract serial suffix from device path (e.g., /dev/particle_1234 -> 1234)
    SERIAL_SUFFIX="${DEVICE##*/dev/particle_}"

    echo "üîå Connecting to $DEVICE (serial: ...$SERIAL_SUFFIX)..."
    MACO_PROJECT_ROOT="$_PW_SCRIPT_DIR" exec bazelisk run //maco_firmware/apps/dev:console -- \
      --device "$DEVICE" \
      --device-serial-suffix "$SERIAL_SUFFIX"
    ;;
  factory-flash)
    echo "üîå Flashing factory firmware..."
    exec bazelisk run //maco_firmware/apps/factory:flash
    ;;
  factory-console)
    # Connect factory console to Particle device via serial
    # Usage: ./pw factory-console [--device-serial=XXXX]

    DEVICE_SERIAL=""
    for arg in "$@"; do
      case "$arg" in
        --device-serial=*)
          DEVICE_SERIAL="${arg#*=}"
          ;;
      esac
    done

    find_particle_device() {
      local serial_filter="$1"
      local timeout=30
      local elapsed=0

      while (( elapsed < timeout )); do
        local devices=(/dev/particle_*)

        if [[ -e "${devices[0]}" ]]; then
          if [[ -n "$serial_filter" ]]; then
            for dev in "${devices[@]}"; do
              if [[ "$dev" == *"$serial_filter" ]]; then
                echo "$dev"
                return 0
              fi
            done
          elif (( ${#devices[@]} == 1 )); then
            echo "${devices[0]}"
            return 0
          else
            echo "üîå Multiple Particle devices found:" >&2
            local i=1
            for dev in "${devices[@]}"; do
              echo "   $i) $dev" >&2
              ((i++))
            done
            echo -n "Select device [1-${#devices[@]}]: " >&2
            read -r selection
            if [[ "$selection" =~ ^[0-9]+$ ]] && (( selection >= 1 && selection <= ${#devices[@]} )); then
              echo "${devices[$((selection-1))]}"
              return 0
            fi
            echo "‚ùå Invalid selection" >&2
            return 1
          fi
        fi

        if (( elapsed == 0 )); then
          if [[ -n "$serial_filter" ]]; then
            echo "‚è≥ Waiting for device *$serial_filter..." >&2
          else
            echo "‚è≥ Waiting for Particle device..." >&2
          fi
        fi
        sleep 1
        ((elapsed++))
      done

      echo "‚ùå No matching Particle device found" >&2
      return 1
    }

    DEVICE=$(find_particle_device "$DEVICE_SERIAL") || exit 1
    SERIAL_SUFFIX="${DEVICE##*/dev/particle_}"

    echo "üè≠ Factory console -> $DEVICE (serial: ...$SERIAL_SUFFIX)..."
    MACO_PROJECT_ROOT="$_PW_SCRIPT_DIR" exec bazelisk run //maco_firmware/apps/factory:console -- \
      --device "$DEVICE" \
      --device-serial-suffix "$SERIAL_SUFFIX"
    ;;
esac

# For all other commands, use the workflows launcher
if [ -t 1 ]; then
  printf " ‚è±  Initializing pw tool...\r"
fi

declare -r _PW_WORKFLOWS_BIN_PATH=${_PW_WORKFLOWS_OUT_DIR}/bazel-bin/pw.exe

# If the `pw` tool hasn't been built yet, don't silence output since it might
# take a long time.
if [ -f "$_PW_WORKFLOWS_BIN_PATH" ]; then
  declare -r _PW_WORKFLOWS_QUIET=--quiet
else
  declare -r _PW_WORKFLOWS_QUIET
fi

bazelisk \
  ${_PW_WORKFLOWS_QUIET} \
  --output_base=${_PW_WORKFLOWS_OUT_DIR} \
  run \
  --symlink_prefix=${_PW_WORKFLOWS_OUT_DIR}/bazel- \
  --show_result=0 \
  //:pw -- "$@"
