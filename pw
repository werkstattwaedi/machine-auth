#!/bin/bash
# Copyright Offene Werkstatt W√§denswil
# SPDX-License-Identifier: MIT
#
# Pigweed workflow launcher wrapper script.
#
# This script runs bazel in an isolated environment that doesn't interfere
# with the IDE's compile_commands. Use this for:
# - Flashing firmware (./pw flash)
# - Running workflow builds (./pw build host, ./pw build p2)
# - Any command that shouldn't update compile_commands

# Don't generate compile commands from this action.
# BAZELISK_SKIP_WRAPPER=1 tells bazelisk to skip the tools/bazel wrapper.
export BAZELISK_SKIP_WRAPPER=1

declare -r _PW_SCRIPT_DIR=$(realpath $(dirname $0))
declare -r _PW_WORKFLOWS_OUT_DIR=${_PW_SCRIPT_DIR}/out/workflows_launcher

# Handle special commands that need 'bazel run' instead of workflows
case "$1" in
  flash)
    # Flash requires 'bazel run' to actually execute the flash script
    echo "üîå Flashing firmware..."
    exec bazelisk run //maco_firmware/apps/dev:flash
    ;;
  run)
    # Allow running arbitrary targets: ./pw run //target
    shift
    exec bazelisk run "$@"
    ;;
  test)
    # Run host unit tests without affecting IDE state
    shift
    TARGETS="${@:-//maco_firmware/...}"
    echo "üß™ Running tests..."
    exec bazelisk \
      --output_base=${_PW_WORKFLOWS_OUT_DIR} \
      test \
      --symlink_prefix=${_PW_WORKFLOWS_OUT_DIR}/bazel- \
      $TARGETS
    ;;
  console-sim)
    # Connect to simulator on localhost:33000
    echo "üñ•Ô∏è  Connecting to simulator..."
    TOKEN_DB="${_PW_SCRIPT_DIR}/bazel-bin/maco_firmware/apps/dev/simulator_binary"
    if [[ -f "$TOKEN_DB" ]]; then
      exec bazelisk run //tools:console -- --socket-addr default --token-databases "$TOKEN_DB"
    else
      echo "‚ö†Ô∏è  Token database not found. Run 'bazel build //maco_firmware/apps/dev:simulator' first."
      exec bazelisk run //tools:console -- --socket-addr default
    fi
    ;;
  console)
    # Connect to Particle device via serial
    # Probe for /dev/particle_* devices
    find_particle_device() {
      local devices=(/dev/particle_*)
      local timeout=10
      local elapsed=0

      # If no devices found, wait up to 10 seconds
      while [[ ! -e "${devices[0]}" ]] && (( elapsed < timeout )); do
        if (( elapsed == 0 )); then
          echo "‚è≥ Waiting for Particle device..."
        fi
        sleep 1
        ((elapsed++))
        devices=(/dev/particle_*)
      done

      # Check results
      if [[ ! -e "${devices[0]}" ]]; then
        echo "‚ùå No Particle device found at /dev/particle_*"
        echo "   Make sure the device is connected and the udev rule is installed."
        exit 1
      elif (( ${#devices[@]} == 1 )); then
        echo "${devices[0]}"
      else
        echo "üîå Multiple Particle devices found:" >&2
        local i=1
        for dev in "${devices[@]}"; do
          echo "   $i) $dev" >&2
          ((i++))
        done
        echo -n "Select device [1-${#devices[@]}]: " >&2
        read -r selection
        if [[ "$selection" =~ ^[0-9]+$ ]] && (( selection >= 1 && selection <= ${#devices[@]} )); then
          echo "${devices[$((selection-1))]}"
        else
          echo "‚ùå Invalid selection" >&2
          exit 1
        fi
      fi
    }

    DEVICE=$(find_particle_device)
    echo "üîå Connecting to $DEVICE..."
    # Token DB is in the p2_system platform output (platform transition puts it here)
    TOKEN_DB="${_PW_SCRIPT_DIR}/bazel-out/p2_system-fastbuild/bin/maco_firmware/apps/dev/dev"
    if [[ -f "$TOKEN_DB" ]]; then
      exec bazelisk run //tools:console -- --device "$DEVICE" --token-databases "$TOKEN_DB"
    else
      echo "‚ö†Ô∏è  Token database not found. Run './pw build p2' first."
      exec bazelisk run //tools:console -- --device "$DEVICE"
    fi
    ;;
esac

# For all other commands, use the workflows launcher
if [ -t 1 ]; then
  printf " ‚è±  Initializing pw tool...\r"
fi

declare -r _PW_WORKFLOWS_BIN_PATH=${_PW_WORKFLOWS_OUT_DIR}/bazel-bin/pw.exe

# If the `pw` tool hasn't been built yet, don't silence output since it might
# take a long time.
if [ -f "$_PW_WORKFLOWS_BIN_PATH" ]; then
  declare -r _PW_WORKFLOWS_QUIET=--quiet
else
  declare -r _PW_WORKFLOWS_QUIET
fi

bazelisk \
  ${_PW_WORKFLOWS_QUIET} \
  --output_base=${_PW_WORKFLOWS_OUT_DIR} \
  run \
  --symlink_prefix=${_PW_WORKFLOWS_OUT_DIR}/bazel- \
  --show_result=0 \
  //:pw -- "$@"
