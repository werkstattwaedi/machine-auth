rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      // Custom claims set by syncCustomClaims Cloud Function
      // when user doc roles[] includes "admin"
      return isSignedIn() && request.auth.token.admin == true;
    }

    // Validation helpers
    function isDocumentReference(field, collection) {
      return field is path;
    }

    function isDocumentReferenceArray(arr, collection) {
      return arr is list && arr.size() >= 0;
    }

    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();

      // Allow creating new users during sign-up
      allow create: if true &&
                       request.resource.data.permissions is list &&
                       isDocumentReferenceArray(request.resource.data.permissions, 'permission');

      // Users can update their own doc but cannot change roles/permissions/firebaseUid
      allow update: if isAdmin() ||
                       (isSignedIn() &&
                        request.resource.data.firebaseUid == request.auth.uid &&
                        request.resource.data.roles == resource.data.roles &&
                        request.resource.data.permissions == resource.data.permissions &&
                        request.resource.data.firebaseUid == resource.data.firebaseUid);

      allow delete: if isAdmin();
    }

    // Permission collection
    match /permission/{permissionId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Tokens collection
    match /tokens/{tokenId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Machines collection
    match /machine/{machineId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() &&
                      isDocumentReference(request.resource.data.maco, 'maco') &&
                      isDocumentReferenceArray(request.resource.data.requiredPermission, 'permission');
    }

    // MaCo (terminals) collection
    match /maco/{deviceId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Sessions collection
    match /sessions/{sessionId} {
      allow read: if isSignedIn();
      allow create, update: if isAdmin() &&
                               isDocumentReference(request.resource.data.userId, 'users') &&
                               isDocumentReference(request.resource.data.tokenId, 'tokens');
      allow delete: if isAdmin();
    }

    // Machine usage (from MaCo terminals)
    match /usage_machine/{usageId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Material usage (from QR scans + manual entry)
    match /usage_material/{usageId} {
      allow read: if isSignedIn();
      allow create: if true;
      allow update: if isSignedIn();
      allow delete: if isAdmin();
    }

    // Checkouts
    match /checkouts/{checkoutId} {
      allow create: if true;
      allow read: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // Materials catalog (public read for QR scan page)
    match /materials/{materialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Audit log (admin read only, no client writes)
    match /audit_log/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // Machine issue reports
    match /machine_reports/{reportId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }
  }
}
